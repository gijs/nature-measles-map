<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
}

.outerwrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
}
.outerwrapper h2, .outerwrapper h3, .outerwrapper p {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outerwrapper .axis {
  font: 10px sans-serif;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}
.outerwrapper .axis .domain {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  stroke-width: 10px;
  stroke-linecap: round;
}
.outerwrapper .axis .halo {
  fill: none;
  stroke: #ddd;
  stroke-width: 8px;
  stroke-linecap: round;
}
.outerwrapper .slider .handle {
  fill: #fff;
  stroke: #000;
  stroke-opacity: .5;
  stroke-width: 1.25px;
  cursor: crosshair;
}

</style>
<div class="outerwrapper">
	<h2>I hope this works</h2>
	<div id="chart"></div>

	<div class="controls" id="year-slider"></div>
</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function BuildWidget (mapTarget, brushTarget, params, features, world) {
	this.mapTarget = mapTarget;
	this.brushTarget = brushTarget;
	this.params = params;
	this.features = features;
	this.world = world;
}
function buildParams () {
	var params = {};

	var contentWidth = jQuery("#content").width();

	/*	Map margin, width and height */
	params.mapMargin = {top: 0, right: 0, mid: 0, bottom: 0, left: 0};
	params.mapWidth = contentWidth  - params.mapMargin.left - params.mapMargin.right;
	params.mapHeight = contentWidth - params.mapMargin.top - params.mapMargin.bottom;

	/*	Brush margin, width and height */
	params.brushMargin = {top: 0, right: 30, bottom: 0, left: 30};
	params.brushWidth = contentWidth  - params.brushMargin.left - params.brushMargin.right;
	params.brushHeight = 50 - params.brushMargin.top - params.brushMargin.bottom;

	params.brushScale = d3.scale.linear()
							.domain([1980, 2013])
							.range([0, params.brushWidth])
							.clamp(true);

	params.format = d3.format("0,000");

	params.year = "1980";

	/* Max value is 1122285 -> from Excel */
	params.color = d3.scale.linear()
					.range(["#ffffb2", "#e31a1c"])
					.domain([0,100000])
					.clamp("true");

	params.projection = d3.geo.mercator()
						.scale(650)
    					.translate([params.mapWidth / 2, params.mapHeight / 2]);

	params.path = d3.geo.path()
					.projection(params.projection);

	return params;
}
BuildWidget.prototype.buildMap = function() {
	var self = this;

	this.svg = d3.select(this.mapTarget).append("svg")
					.attr("width", this.params.mapWidth)
					.attr("height", this.params.mapHeight);
				  
	this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.mapWidth)
					.attr("height", this.params.mapHeight);

	this.clipGroupSvg = this.svg.append("g").attr("clip-path", "url(#clip)");

	this.countriesSVG = this.clipGroupSvg.append("g");
	this.bordersSVG = this.clipGroupSvg.append("g");

	this.svg.call(d3.behavior.zoom()
			.translate([0, 0])
			.scale(1)
			.scaleExtent([1, 8])
			.on("zoom", zoomed));

	this.countriesSVG.selectAll("path")
		.data(this.features)
		.enter().append("path")
		.attr("d", this.params.path)
		.attr("fill", function (d) {
			if ( d.values ) {
				if ( d.values[0][self.params.year] === "noData") {
					return "#ccc";
				} else {
					return self.params.color(d.values[0][self.params.year]);
				}

			} else {
				return "#ccc";
			}
		})
		.on("click", function (d) {
			if ( d.values ) {
				if ( d.values[0][self.params.year] === "noData") {
					console.log(d.values[0].Cname +  ": No Data");
				} else {
					console.log(d.values[0].Cname + ": " + d.values[0][self.params.year] + " cases");
				}
			} else {
				console.log(d.id + ": No Data");
			}
		});

	this.bordersSVG.append("path")
		.datum(topojson.mesh(self.world, self.world.objects.units, function(a, b) { return a !== b; }))
		.attr("d", this.params.path)
		.attr("class", "subunit-boundary")
		.attr("fill", "none")
		.attr("stroke", "#666")
		.attr("stroke-width", "0.1px");

	function zoomed() {
		self.svg.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		self.countriesSVG.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		self.bordersSVG.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		// console.log(d3.event.scale);
	}


};

/* http://bl.ocks.org/mbostock/6452972 */
BuildWidget.prototype.buildBrush = function(first_argument) {
	var self = this;

	this.brush = d3.svg.brush()
					.x(this.params.brushScale)
					.extent(0, 0)
					.on("brush", brushed);

	this.rangeSvg = d3.select(this.brushTarget).append("svg")
						.attr("width", this.params.brushWidth + this.params.brushMargin.left + this.params.brushMargin.right)
						.attr("height", this.params.brushHeight)
					  .append("g")
						.attr("transform", "translate(" + this.params.brushMargin.left + "," + this.params.brushMargin.top + ")");

	this.brushAxis = d3.svg.axis()
						.scale(self.params.brushScale)
						.orient("bottom")
						.tickFormat(function(d) { return d; })
						.tickSize(0)
						.ticks(20)
						.tickPadding(12);

	this.rangeSvg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + this.params.brushHeight / 2 + ")")
	    .call(this.brushAxis)
	  .select(".domain")
	  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
	    .attr("class", "halo");

	this.slider = this.rangeSvg.append("g")
    	.attr("class", "slider")
    	.call(this.brush);

	this.slider.selectAll(".extent,.resize")
    	.remove();

	this.handle = this.slider.append("circle")
	    .attr("class", "handle")
	    .attr("transform", "translate(0," + this.params.brushHeight  / 2 + ")")
	    .attr("r", 9);

	function brushed() {
		var value = self.brush.extent()[0];

		if (d3.event.sourceEvent) { /* not a programmatic event*/
			value = self.params.brushScale.invert(d3.mouse(this)[0]);
			self.brush.extent([value, value]);
		}

		self.handle.attr("cx", self.params.brushScale(value));

		/* should probably snap to a value */
		self.params.year = Math.floor(value);
		self.updateMap();
	}
};

// function buildData () {}

// buildKey.js
// buildScales.js
// buildTooltip.js
BuildWidget.prototype.updateMap = function() {
	var self = this;

	var year = self.params.year.toString();

	this.countriesSVG.selectAll("path")
		.attr("fill", function (d) {
			if ( d.values ) {
				if ( d.values[0][year] === "noData") {
					return "#ccc";
				} else {
					return self.params.color(d.values[0][year]);
				}

			} else {
				return "#ccc";
			}
		});
};

(function() {
	var init = function($) {

		$.when( $.getScript("http://www.nature.com/polopoly_static/js/d3.v3.min.js"),
				$.getScript("http://d3js.org/topojson.v1.min.js")
		).then( function () {

			

			d3.csv("data/cases-by-who-region-edit.csv", function (d) {
				/* Convert the text numbers into real numbers */
				/* If the number is "" make it zero */
				d.forEach(function (element) {
					for (var i = 1980; i < 2014; i++) {
						element[i] = parseInt(element[i], 10) || "noData";
					}
				});

				/*  Nest the data by country code */
				var nestedData = d3.nest()
									.key( function (d) {
										return d.ISO_code;
									})
									.entries(d);

				d3.json("data/countries.json", function(error, world) {

					var features = topojson.feature(world, world.objects.units).features;

					for (var i = 0; i < features.length; i++) {

						for (var k = 0; k < nestedData.length; k++) {

							if ( nestedData[k].key === features[i].id ) {
								features[i].values = nestedData[k].values;
							}
						}
					}

					var params = buildParams();

					var measlesMap = new BuildWidget("#chart", "#year-slider", params, features, world);

					measlesMap.buildMap();
					measlesMap.buildBrush();

				});
			});
		});

	/* End of active code */
	};


	setTimeout(function() {
		if (typeof jQuery !== 'undefined') {
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();
</script>
<!--<![endif]-->
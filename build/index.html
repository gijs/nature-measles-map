<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Polopoly</title>
	<script src="http://nature.com/view/scripts/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<!-- <script src="https://poly-admin1.nature.com/polopoly_static/js/jquery-1.6.4.js" type="text/javascript"></script> -->

	<link rel="stylesheet" type="text/css" href="polopoly/reset.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/html5.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/layout.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/header.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/footer.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/news-main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/comments.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/mobile.css" />	
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=2.2,user-scalable=yes"/>


</head>


<!--[if lt IE 6]><body class="lt-ie6"><![endif]-->
<!--[if IE 6]><body class="ie6"><![endif]-->
<!--[if IE 7]><body class="ie7"><![endif]-->
<!--[if IE 8]><body class="ie8"><![endif]-->
<!--[if gt IE 8]><body class="gt-ie8"><![endif]-->
<!--[if !IE]>--><body><!--<![endif]-->

<div id="constrain">

<div id="main">
	<div id="constrain-content" class="cleared">
		<div id="content" class="col">
			<article>
				<div id="article">
					<section>
						<div class="section">
							<div class="html-widget img-rigth">

<!-- ========= PASTED POLOPOLY HEADER ABOVE ========= -->







<style scoped>
.widget-status-message, .widget-error-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
}

.widget-error-message {
  display: none;
}

.outerwrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none;
}
.outerwrapper .header h2 {
  padding: 10px 15px;
  margin: 0;
}
.outerwrapper .header p {
  padding: 0 15px;
  margin: 0;
}
.outerwrapper .toggle-buttons {
  margin: 10px 10px;
}
.outerwrapper .toggle-buttons button {
  display: inline-block;
  background-color: #eee;
  border: none;
  padding: 10px;
  border-radius: 4px;
  box-sizing: border-box;
  border: 1px solid #fff;
  transition: background-color 0.2s ease;
}
.outerwrapper .toggle-buttons button.selected {
  border: 1px solid #666;
  background-color: #ccc;
}
.outerwrapper .toggle-buttons button:hover {
  background-color: #aaa;
}
.outerwrapper .toggle-buttons button:active {
  background-color: #666;
}
.outerwrapper .chart {
  position: relative;
  background-color: #65A6D3;
  line-height: 0;
  margin: 0 15px;
}
.outerwrapper .chart h3 {
  position: absolute;
  margin: 0;
  top: 20px;
  left: 10px;
  z-index: 99;
  font-size: 1.5em;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}
.outerwrapper .chart svg {
  cursor: crosshair;
}
.outerwrapper .chart svg .country path {
  cursor: pointer;
}
.outerwrapper .axis {
  font: 10px sans-serif;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}
.outerwrapper .controls {
  margin: 0 15px;
}
.outerwrapper .controls .axis .domain {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  stroke-width: 10px;
  stroke-linecap: round;
}
.outerwrapper .controls .axis .halo {
  fill: none;
  stroke: #ddd;
  stroke-width: 8px;
  stroke-linecap: round;
}
.outerwrapper .controls .slider .handle {
  fill: #fff;
  stroke: #000;
  stroke-opacity: .5;
  stroke-width: 1.25px;
  cursor: crosshair;
}
.outerwrapper .key {
  margin-bottom: 10px;
}
.outerwrapper .key h3 {
  padding: 10px 15px;
  margin: 0;
}
.outerwrapper .key ul {
  margin: 0px 15px 0px 5px;
}
.outerwrapper .key li {
  display: inline-block;
  margin-top: 5px;
  margin-left: 10px;
  padding-left: 5px;
  padding-top: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 10px;
  line-height: 1em;
  border-left: 1px solid black;
  min-width: 60px;
}
.outerwrapper .info-box {
  background-color: #ececec;
  margin: 0 15px 15px 15px;
  clear: both;
}
.outerwrapper .info-box .life-cycle-chart, .outerwrapper .info-box .vaccination-chart {
  position: relative;
}
.outerwrapper .info-box .life-cycle-header {
  padding: 15px 15px 5px;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-justify-content: space-between;
      -ms-flex-pack: justify;
          justify-content: space-between;
}
.outerwrapper .info-box p {
  padding: 0;
  margin: 0;
}
.outerwrapper .info-box svg {
  margin: 0 0 10px 0;
}
.outerwrapper .info-box .widget-tooltip {
  position: absolute;
  height: auto;
  padding: 6px 10px 6px 15px;
  color: #ccc;
  background-color: #333;
  pointer-events: none;
  border-radius: 5px;
  font-size: 0.8em;
  line-height: 1.4em;
  opacity: 1;
  transition: opacity 0.2s ease;
}
.outerwrapper .info-box .widget-tooltip p {
  padding: 0;
}
.outerwrapper .info-box .widget-tooltip span {
  font-weight: bold;
  color: #fff;
}
.outerwrapper .info-box .hidden {
  opacity: 0;
  pointer-events: none;
}
.outerwrapper .info-box .axis path, .outerwrapper .info-box .axis line, .outerwrapper .info-box .numbersGroup path, .outerwrapper .info-box .numbersGroup line {
  fill: none;
  stroke: #666;
}

</style>
<div class="widget-status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari or Firefox) with javascript enabled.</p>
</div>

<div class="widget-error-message">
	<p>The data needed for this interactive graphic has failed to load.</p>
</div>

<div class="outerwrapper">
	<div class="header">
		<h2>Headline</h2>
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aspernatur molestiae voluptas deleniti, velit a, culpa reprehenderit eaque aut repellendus. Hic vero voluptates magni voluptas perspiciatis quos, exercitationem suscipit reiciendis rem.</p>
	</div>
	
	<div class="toggle-buttons">
		<button id="toggle-cases">Cases of measles</button>
		<button id="toggle-vaccination">Vaccination rate %</button>
	</div>

	<div class="key" id="measles-scale"></div>

	<div id="chart" class="chart"></div>
	
	<div class="controls" id="year-slider"></div>

	<div class="info-box" id="info-box">
		
		<div class="life-cycle-header">
			<p class="country" id="selected-country"></p>
			<label>Scale y axis: <input id="scale-y-axis" type="checkbox" checked></label>
		</div>
		
		<div class="life-cycle-chart" id="life-cycle-chart">
			<div class="widget-tooltip hidden" id="widget-tooltip">
				<p id="circle-cases"></p>
			</div>
		</div>

		<div class="vaccination-chart" id="vaccination-chart">
			<div class="widget-tooltip hidden" id="vaccination-tooltip">
				<p id="circle-vaccination"></p>
			</div>
		</div>
	</div>
</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function extendObject (myObject) {
	/*	Referenced from: http://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript */
	
	/*	Storage for topics that can be broadcast or listened to */
	var topics = {};

	/*	A topic identifyer */
	var subUid = -1;

	/*	Publish or broadcast events of interest
		with a specific topic name and arguments
		such as the data to pass along */
	myObject.publish = function ( topic, args ) {
		
		if ( !topics[topic] ) {
			return false;
		}

		var subscribers = topics[topic];
		var len = subscribers ? subscribers.length : 0;

		while (len--) {
			subscribers[len].func( topic, args );
		}	

		return this;
	};

	/*	Subscribe to events of interest with a specific topic name and a 
		callback function, to be executed with the topic/event is observed */
	myObject.subscribe = function ( topic, func, parent ) {
		
		if ( !topics[topic] ) {
			topics[topic] = [];
		}

		var token = ( ++subUid ).toString();
		topics[topic].push({
			token: token,
			func: func,
			parent: parent
		});
		return token;
	};
}

function BuildWidget (params, features, worldData) {
	this.params = params;
	this.features = features;
	this.world = worldData;
	this.pubsub = {};
}

function buildParams () {
	var params = {};

	var contentWidth = jQuery("#content").width();

	params.mapScale = 100;
	params.ticks = 20;
	params.lifeCycleRadius = "4px";
	params.mapRatio = 0.5;

	if ( contentWidth < 310 ) {
		params.mapScale = 50;
		params.ticks = 5;
		params.lifeCycleRadius = "2px";
		params.mapRatio = 0.8;
	}

	params.uiColour = {
		veryLightGrey: "#ddd",
		lightGrey: "#999",
		grey: "#666",
		darkGrey: "#333",
		noData: "#ccc",
		lineColour: "#cb181d",
		vaccinationLineColour: "#238b45"	
	};

	params.key = {
		keyRange: [20000, 40000, 60000, 80000, 100000, 120000, 140000, 160000, 180000, 200000],
		vaccinationRange: [10,20,30,40,50,60,70,80,90,100],
		verticalShift: [20, 36, 60],
		horizontalShift: 25,
		keyHead: "Cases of measles",
		keyHeadVaccination: "Vaccination rate %"
	};

	/* Life cycle data */
	params.selectedCountry = "United States of America (the)";
	params.selectedID = "USA";
	params.selectedData = [];
	params.selectedVaccinationData = [];
	params.selectedMaxArray = [];
	params.selectedFeature = 202;

	/* Target ids */
	params.mapTarget = "#chart";
	params.brushTarget = "#year-slider";
	params.keyTarget = "#measles-scale";
	params.lifeCycleChartTarget = "#life-cycle-chart";
	params.vaccinationChartTarget = "#vaccination-chart";
	params.selectedCountryTarget = "#selected-country";
	params.checkboxTarget = "#scale-y-axis";

	/*	Map margin, width and height */
	params.mapMargin = {top: 0, right: 15, bottom: 0, left: 15};
	params.mapWidth = contentWidth  - params.mapMargin.left - params.mapMargin.right;
	params.mapHeight = (contentWidth * params.mapRatio) - params.mapMargin.top - params.mapMargin.bottom;

	/*	Brush margin, width and height */
	params.brushMargin = {top: 0, right: 10, bottom: 0, left: 70};
	params.brushWidth = contentWidth  - params.brushMargin.left - params.brushMargin.right - 30;
	params.brushHeight = 50 - params.brushMargin.top - params.brushMargin.bottom;

	/*	Lifecycle margin, width and height */
	params.lifeCycleMargin = {top: 10, right: 10, bottom: 20, left: 70};
	params.lifeCycleWidth = contentWidth - params.lifeCycleMargin.left - params.lifeCycleMargin.right - 30;
	params.lifeCycleHeight = 100;
	params.scaleYAxis = true;


	params.brushScale = d3.scale.linear()
							.domain([1980, 2013])
							.range([0, params.brushWidth])
							.clamp(true);

	params.format = d3.format("0,000");

	params.year = "1980";

	params.duration = 100;

	params.showCases = true;

	/* Max value is 1122285 -> from Excel */
	params.color = d3.scale.linear()
					.range(["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d","#000000"])
					.domain(params.key.keyRange)
					.clamp(true);

	params.vaccinationColor = d3.scale.linear()
								.range(["#ffffff","#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"])
								.domain(params.key.vaccinationRange)
								.clamp(true);

	params.projection = d3.geo.mercator()
						.scale(params.mapScale)
    					.translate([(params.mapWidth * 0.5), (params.mapHeight * 0.6)]);

	params.path = d3.geo.path()
					.projection(params.projection);

	return params;
}

BuildWidget.prototype.buildMap = function() {
	var self = this;

	this.svg = d3.select(this.params.mapTarget).append("svg")
					.attr("width", this.params.mapWidth)
					.attr("height", this.params.mapHeight);
				  
	this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.mapWidth)
					.attr("height", this.params.mapHeight);

	this.clipGroupSvg = this.svg.append("g").attr("clip-path", "url(#clip)");

	this.countriesSvg = this.clipGroupSvg.append("g").attr("class","country");
	this.bordersSvg = this.clipGroupSvg.append("g");

	this.svg.call(d3.behavior.zoom()
			.translate([0, 0])
			.scale(1)
			.scaleExtent([1, 8])
			.on("zoom", zoomed));

	this.countriesSvg.selectAll("path")
		.data(this.features)
		.enter().append("path")
		.attr("d", this.params.path)
		.attr("id", function (d) {
			return d.id;
		})
		.attr("fill", function (d) {
			if ( d.caseData ) {
				if ( self.params.showCases ) {
					if ( d.caseData[0][self.params.year] === "noData") {
						return self.params.uiColour.noData;
					} else {
						return self.params.color(d.caseData[0][self.params.year]);
					}
				} else if ( d.vaccineData ) {
					if ( d.vaccineData[0][self.params.year] === "noData") {
						return self.params.uiColour.noData;
					} else {
						return self.params.vaccinationColor(d.vaccineData[0][self.params.year]);
					}					
				}
			} else {
				return self.params.uiColour.noData;
			}
		})
		.on("click", function (d,i) {
			self.params.selectedFeature = i;
			self.pubsub.publish("newCountryChosen");
		});

	this.bordersSvg.append("path")
		.datum(topojson.mesh(self.world, self.world.objects.units, function(a, b) { return a !== b; }))
		.attr("d", this.params.path)
		.attr("class", "subunit-boundary")
		.attr("fill", "none")
		.attr("stroke", "#666")
		.attr("stroke-width", "0.1px");

	this.yearLabel = d3.select(this.params.mapTarget).append("h3");

	this.yearLabel.text(this.params.year);
	
	function zoomed() {
		self.countriesSvg.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		self.bordersSvg.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
	}
};

/* http://bl.ocks.org/mbostock/6452972 */
BuildWidget.prototype.buildBrush = function(first_argument) {
	var self = this;

	this.brush = d3.svg.brush()
					.x(this.params.brushScale)
					.extent([0, 0])
					.on("brush", brushed);

	this.rangeSvg = d3.select(this.params.brushTarget).append("svg")
						.attr("width", this.params.brushWidth + this.params.brushMargin.left + this.params.brushMargin.right)
						.attr("height", this.params.brushHeight + this.params.brushMargin.top + this.params.brushMargin.bottom)
					  .append("g")
						.attr("transform", "translate(" + this.params.brushMargin.left + "," + this.params.brushMargin.top + ")");

	this.brushAxis = d3.svg.axis()
						.scale(self.params.brushScale)
						.orient("bottom")
						.tickFormat(function(d) { return d; })
						.tickSize(0)
						.ticks(this.params.ticks)
						.tickPadding(12);

	this.rangeSvg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + this.params.brushHeight / 2 + ")")
	    .call(this.brushAxis)
	  .select(".domain")
	  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
	    .attr("class", "halo");

	this.slider = this.rangeSvg.append("g")
    	.attr("class", "slider")
    	.call(self.brush);

	this.slider.selectAll(".extent,.resize")
    	.remove();

	this.handle = this.slider.append("circle")
	    .attr("class", "handle")
	    .attr("transform", "translate(0," + this.params.brushHeight  / 2 + ")")
	    .attr("r", 9);

	function brushed() {
		var value = self.brush.extent()[0];

		if (d3.event.sourceEvent) { /* not a programmatic event*/
			value = Math.floor(self.params.brushScale.invert(d3.mouse(this)[0]));
			self.brush.extent([value, value]);
		}

		self.handle.attr("cx", self.params.brushScale(value));

		/* should probably snap to a value */
		self.params.year = Math.floor(value);
		self.pubsub.publish("newYearChosen");
	}
};

BuildWidget.prototype.buildLifeCycle = function() {
	var self = this;

	this.selectedCountryLabel = d3.select(this.params.selectedCountryTarget).text(this.params.selectedCountry);

	this.lifeCycleSvg = d3.select(this.params.lifeCycleChartTarget).append("svg")
		.attr("width", this.params.lifeCycleWidth + this.params.lifeCycleMargin.left + this.params.lifeCycleMargin.right)
		.attr("height", this.params.lifeCycleHeight + this.params.lifeCycleMargin.top + this.params.lifeCycleMargin.bottom)
	  .append("g")
		.attr("transform", "translate(" + this.params.lifeCycleMargin.left + "," + this.params.lifeCycleMargin.top + ")");

	this.lifeCycleSvg.append("g")
		.attr("class","white-box")
	  .append("rect")
		.attr("x", 0)
		.attr("y", 0)
		.attr("width", this.params.lifeCycleWidth)
		.attr("height", this.params.lifeCycleHeight)
		.attr("fill","#FFF");

	this.xScaleLifeCycle = d3.scale.linear()
		.range([0, this.params.lifeCycleWidth])
		.domain([1980, 2013]);

	this.yScaleLifeCycle = d3.scale.linear()
		.range([this.params.lifeCycleHeight, 0]);

	if ( this.params.scaleYAxis ) {
		this.yScaleLifeCycle.domain([0, (d3.max(self.params.selectedData, function(d) { return d.cases; }) * 1.1) ]);
	} else {
		this.yScaleLifeCycle.domain([0, 1235000 ]);
	}

	this.xAxisLifeCycle = d3.svg.axis()
		.scale(this.xScaleLifeCycle)
		.tickFormat(function(d) { return d; })
		.ticks(this.params.ticks)
		.orient("bottom");

	this.yAxisLifeCycle = d3.svg.axis()
		.scale(this.yScaleLifeCycle)
		.ticks(5)
		.tickSize(-this.params.lifeCycleWidth, 0)
		.orient("left");

	this.line = d3.svg.line()
		.x(function(d) { return self.xScaleLifeCycle(d.date); })
		.y(function(d) { return self.yScaleLifeCycle(d.cases); });

	this.lifeCycleSvg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + this.params.lifeCycleHeight + ")")
	    .call(this.xAxisLifeCycle);

	this.lifeCycleSvg.append("g")
	    .attr("class", "y axis")
	    .call(this.yAxisLifeCycle)
	  .append("text")
	    .attr("transform", "translate(" + -(this.params.lifeCycleMargin.left * 0.9) + "," + (this.params.lifeCycleHeight/2) + "), rotate(-90)")
	    .attr("y", 6)
	    .attr("dy", ".5em")
	    .style("text-anchor", "middle")
	    .text(this.params.key.keyHead);

	this.lifeCycleLine = this.lifeCycleSvg.append("path")
		.data([this.params.selectedData, function (d) {
			return d.date;
		}])
		.attr("class","line")
		.attr("fill", "none")
		.attr("stroke", this.params.uiColour.lineColour)
		.attr("stroke-width", self.params.lifeCycleRadius)
		.attr("d", this.line);

	this.lifeCycleCircles = this.lifeCycleSvg.append("g");

	this.lifeCycleCircles.selectAll("circle")
		.data(this.params.selectedData, function (d) {
			return d.date;
		})
		.enter().append("circle")
		.attr("cx", function(d) {
			return self.xScaleLifeCycle(d.date);
		})
		.attr("cy", function(d) {
			return self.yScaleLifeCycle(d.cases);
		})
		.attr("r", self.params.lifeCycleRadius)
		.attr("fill", this.params.uiColour.veryLightGrey)
		.attr("stroke-width",'2px')
		.attr("stroke",this.params.uiColour.lineColour);

};

BuildWidget.prototype.buildVaccinationChart = function() {
	var self = this;

	this.vaccinationSvg = d3.select(this.params.vaccinationChartTarget).append("svg")
		.attr("width", this.params.lifeCycleWidth + this.params.lifeCycleMargin.left + this.params.lifeCycleMargin.right)
		.attr("height", this.params.lifeCycleHeight + this.params.lifeCycleMargin.top + this.params.lifeCycleMargin.bottom)
	  .append("g")
		.attr("transform", "translate(" + this.params.lifeCycleMargin.left + "," + this.params.lifeCycleMargin.top + ")");

	this.vaccinationSvg.append("g")
		.attr("class","white-box")
	  .append("rect")
		.attr("x", 0)
		.attr("y", 0)
		.attr("width", this.params.lifeCycleWidth)
		.attr("height", this.params.lifeCycleHeight)
		.attr("fill","#FFF");

	this.xScaleVaccination = d3.scale.linear()
		.range([0, this.params.lifeCycleWidth])
		.domain([1980, 2013]);

	this.yScaleVaccination = d3.scale.linear()
		.range([this.params.lifeCycleHeight, 0])
		.domain([0, 100]);

	this.xAxisVaccination = d3.svg.axis()
		.scale(this.xScaleVaccination)
		.tickFormat(function(d) { return d; })
		.ticks(this.params.ticks)
		.orient("bottom");

	this.yAxisVaccination = d3.svg.axis()
		.scale(this.yScaleVaccination)
		.ticks(5)
		.tickSize(-this.params.lifeCycleWidth, 0)
		.orient("left");

	this.vaccinationLine = d3.svg.line()
		.x(function(d) { return self.xScaleVaccination(d.date); })
		.y(function(d) { return self.yScaleVaccination(d.rate); });

	this.vaccinationSvg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + this.params.lifeCycleHeight + ")")
	    .call(this.xAxisVaccination);

	this.vaccinationSvg.append("g")
	    .attr("class", "y axis")
	    .call(this.yAxisVaccination)
	  .append("text")
	    .attr("transform", "translate(" + -(this.params.lifeCycleMargin.left * 0.5) + "," + (this.params.lifeCycleHeight/2) + "), rotate(-90)")
	    .attr("y", 6)
	    .attr("dy", ".5em")
	    .style("text-anchor", "middle")
	    .text(this.params.key.keyHeadVaccination);

	this.vaccinationPath = this.vaccinationSvg.append("path")
		.data([this.params.selectedVaccinationData, function (d) {
			return d.date;
		}])
		.attr("class","line")
		.attr("fill", "none")
		.attr("stroke", this.params.uiColour.vaccinationLineColour)
		.attr("stroke-width", self.params.lifeCycleRadius)
		.attr("d", this.vaccinationLine);

	this.vaccinationCircles = this.vaccinationSvg.append("g");

	this.vaccinationCircles.selectAll("circle")
		.data(this.params.selectedVaccinationData, function (d) {
			return d.date;
		})
		.enter().append("circle")
		.attr("cx", function(d) {
			return self.xScaleVaccination(d.date);
		})
		.attr("cy", function(d) {
			return self.yScaleVaccination(d.rate);
		})
		.attr("r", self.params.lifeCycleRadius)
		.attr("fill", this.params.uiColour.veryLightGrey)
		.attr("stroke-width",'2px')
		.attr("stroke",this.params.uiColour.vaccinationLineColour);

};

BuildWidget.prototype.updateLifeCycle = function() {
	var self = this;

	this.selectedCountryLabel.text(this.params.selectedCountry);

	if ( this.features[this.params.selectedFeature].caseData ) {
		if ( this.params.scaleYAxis ) {
			this.yScaleLifeCycle.domain([0, (d3.max(self.params.selectedData, function(d) { return d.cases; }) * 1.1) ]);
		} else {
			this.yScaleLifeCycle.domain([0, 1235000]);
		}

		this.lifeCycleSvg.select(".y")
			.transition()
			.duration(this.params.duration)
			.call(this.yAxisLifeCycle);
			
		this.lifeCycleLine
			.data([this.params.selectedData, function (d) {
				return d.date;
			}])
			.attr("d", this.line);

		this.lifeCycleCircles.selectAll("circle")
			.data(this.params.selectedData, function (d) {
				return d.date;
			})
			.attr("cx", function(d) {
				return self.xScaleLifeCycle(d.date);
			})
			.attr("cy", function(d) {
				return self.yScaleLifeCycle(d.cases);
			});

		this.lifeCycleCircles.selectAll("circle")
			.data(this.params.selectedData, function (d) {
				return d.date;
			})
			.exit()
			.remove();

		this.lifeCycleCircles.selectAll("circle")
			.data(this.params.selectedData, function (d) {
				return d.date;
			})
			.enter().append("circle")
			.attr("cx", function(d) {
				return self.xScaleLifeCycle(d.date);
			})
			.attr("cy", function(d) {
				return self.yScaleLifeCycle(d.cases);
			})
			.attr("r", self.params.lifeCycleRadius)
			.attr("fill", this.params.uiColour.veryLightGrey)
			.attr("stroke-width",'2px')
			.attr("stroke",this.params.uiColour.lineColour);

		this.buildTooltip();
	}
};
 
BuildWidget.prototype.updateVaccinationChart = function() {
	var self = this;

	if ( this.features[this.params.selectedFeature].vaccineData ) {
			
		this.vaccinationPath
			.data([this.params.selectedVaccinationData, function (d) {
				return d.date;
			}])
			.attr("d", this.vaccinationLine);

		this.vaccinationCircles.selectAll("circle")
			.data(this.params.selectedVaccinationData, function (d) {
				return d.date;
			})
			.attr("cx", function(d) {
				return self.xScaleVaccination(d.date);
			})
			.attr("cy", function(d) {
				return self.yScaleVaccination(d.rate);
			});

		this.vaccinationCircles.selectAll("circle")
			.data(this.params.selectedVaccinationData, function (d) {
				return d.date;
			})
			.exit()
			.remove();

		this.vaccinationCircles.selectAll("circle")
			.data(this.params.selectedVaccinationData, function (d) {
				return d.date;
			})
			.enter().append("circle")
			.attr("cx", function(d) {
				return self.xScaleVaccination(d.date);
			})
			.attr("cy", function(d) {
				return self.yScaleVaccination(d.rate);
			})
			.attr("r", self.params.lifeCycleRadius)
			.attr("fill", this.params.uiColour.veryLightGrey)
			.attr("stroke-width",'2px')
			.attr("stroke",this.params.uiColour.vaccinationLineColour);

		this.buildTooltip();
	} else {
		this.vaccinationPath.attr("d", "M0,0 L0,0");

		this.vaccinationCircles.selectAll("circle").remove();
	}
};
BuildWidget.prototype.buildData = function() {
	/*	Remove all the old objects from the arrays */
	while ( this.params.selectedData.length > 0 ) {
		this.params.selectedData.pop();
	}

	while ( this.params.selectedVaccinationData.length > 0 ) {
		this.params.selectedVaccinationData.pop();
	}

	while ( this.params.selectedMaxArray.length > 0 ) {
		this.params.selectedMaxArray.pop();
	}

	if ( this.features[this.params.selectedFeature].vaccineData ) {
		
		for (var j = 1980; j < 2014; j++) {
			if ( this.features[this.params.selectedFeature].vaccineData[0][j] !== "noData" ) {
				var myVaccineObject = {};
				myVaccineObject.date = j; 
				myVaccineObject.rate = this.features[this.params.selectedFeature].vaccineData[0][j];
				this.params.selectedVaccinationData.push(myVaccineObject);
			}
		}
	}

	if ( this.features[this.params.selectedFeature].caseData ) {
		this.params.selectedCountry = this.features[this.params.selectedFeature].caseData[0].Cname;
		
		for (var i = 1980; i < 2014; i++) {
			if ( this.features[this.params.selectedFeature].caseData[0][i] !== "noData" ) {
				var myCaseObject = {};
				myCaseObject.date = i; 
				myCaseObject.cases = this.features[this.params.selectedFeature].caseData[0][i];
				this.params.selectedData.push(myCaseObject);
			}
		}

		this.params.selectedID = this.features[this.params.selectedFeature].id;
		/* Only redraw the graph is the country has some case data */
		this.pubsub.publish("newDataReady");
	}
};

BuildWidget.prototype.buildKey = function() {
	var self = this;

	if ( !this.key ) {
		this.key = d3.select(this.params.keyTarget);
	}

	this.key.html("");

	if ( this.params.showCases ) {
		d3.select("#toggle-cases").classed("selected",true);
		d3.select("#toggle-vaccination").classed("selected",false);
	} else {
		d3.select("#toggle-cases").classed("selected",false);
		d3.select("#toggle-vaccination").classed("selected",true);
	}

	this.list = this.key.append("ul");

	if ( this.params.showCases ) { 
		this.list.selectAll("li")
				.data(this.params.key.keyRange)
				.enter()
			  .append("li")
				.text(function (d,i) {
					if (i === (self.params.key.keyRange.length - 1) ) {
						return "≥ " + self.params.format(d);
					} else if (i === 0) {
						return "≤ " + self.params.format(d);
					} else {
						return self.params.format(d);
					}
				})
				.style("border-top-color", function (d) {
					return self.params.color(d);
				});
	} else {
		this.list.selectAll("li")
				.data(this.params.key.vaccinationRange)
				.enter()
			  .append("li")
				.text(function (d,i) {
					return self.params.format(d) + "%";
				})
				.style("border-top-color", function (d) {
					return self.params.vaccinationColor(d);
				});
	}

		  
	this.list.append("li")
		.text("No data")
		.style("border-top-color", self.params.uiColour.noData);


};

BuildWidget.prototype.buildTooltip = function (selection) {
	var self = this;

	this.lifeCycleCircles.selectAll("circle")
		.on("mouseover", function (d) {
			var myCircle = d3.select(this);

			d3.select("#circle-cases").text(self.params.format(d.cases) + " cases");

			var tooltipWidth = parseInt(d3.select("#widget-tooltip").style("padding-left"),10) + parseInt(d3.select("#widget-tooltip").style("width"),10) + parseInt(d3.select("#widget-tooltip").style("padding-right"),10);

			var top = (parseFloat(myCircle.attr("cy")) + self.params.lifeCycleMargin.top);
			var left = (parseFloat(myCircle.attr("cx")) + self.params.lifeCycleMargin.left);

			if ( parseFloat(myCircle.attr("cx")) > (self.params.lifeCycleWidth / 2) ) {
				left -= tooltipWidth;
			}

			d3.select("#widget-tooltip")
				.style("top",  top + "px")
				.style("left", left + "px")
				.classed("hidden", false);

		}).on("mouseout", function () {
			self.hideTooltip();
		});

	this.vaccinationCircles.selectAll("circle")
		.on("mouseover", function (d) {
			var myCircle = d3.select(this);

			d3.select("#circle-vaccination").text(self.params.format(d.rate) + " %");

			var tooltipWidth = parseInt(d3.select("#vaccination-tooltip").style("padding-left"),10) + parseInt(d3.select("#vaccination-tooltip").style("width"),10) + parseInt(d3.select("#vaccination-tooltip").style("padding-right"),10);

			var top = (parseFloat(myCircle.attr("cy")) + self.params.lifeCycleMargin.top);
			var left = (parseFloat(myCircle.attr("cx")) + self.params.lifeCycleMargin.left);

			if ( parseFloat(myCircle.attr("cx")) > (self.params.lifeCycleWidth / 2) ) {
				left -= tooltipWidth;
			}

			d3.select("#vaccination-tooltip")
				.style("top",  top + "px")
				.style("left", left + "px")
				.classed("hidden", false);

		}).on("mouseout", function () {
			self.hideVaccineTooltip();
		});
};

BuildWidget.prototype.hideTooltip = function () {
	d3.select("#widget-tooltip").classed("hidden", true);
};

BuildWidget.prototype.hideVaccineTooltip = function () {
	d3.select("#vaccination-tooltip").classed("hidden", true);
};

BuildWidget.prototype.buildCheckbox = function() {
	var self = this;
	this.checkbox = d3.select(this.params.checkboxTarget);

	this.checkbox.on("change", function() {
		self.params.scaleYAxis = d3.select(this).property("checked");
		self.pubsub.publish("newDataReady");
	});
};

BuildWidget.prototype.updateMap = function() {
	var self = this;

	var year = self.params.year.toString();

	this.countriesSvg.selectAll("path")
		.attr("fill", function (d) {
			if ( d.caseData ) {
				if ( self.params.showCases ) {
					if ( d.caseData[0][self.params.year] === "noData") {
						return self.params.uiColour.noData;
					} else {
						return self.params.color(d.caseData[0][self.params.year]);
					}
				} else if ( d.vaccineData !== undefined ) {
					if ( d.vaccineData[0][self.params.year] === "noData") {
						return self.params.uiColour.noData;
					} else {
						return self.params.vaccinationColor(d.vaccineData[0][self.params.year]);
					}					
				}
			} else {
				return self.params.uiColour.noData;
			}
		});

	/* Very ugly fix to get around problem with Montenegro */
	if (this.countriesSvg.select("path#MKD").attr("fill") === null) {
		this.countriesSvg.select("path#MKD").attr("fill", self.params.uiColour.noData);
	} 

	this.yearLabel.text(year);
};

BuildWidget.prototype.yearChosen = function (topic, func, parent) {
	this.parent.updateMap();
};

BuildWidget.prototype.countryChosen = function(topic, func, parent) {
	this.parent.buildData();
};

BuildWidget.prototype.dataReady = function(topic, func, parent) {
	if ( this.parent.lifeCycleSvg ) {
		this.parent.updateLifeCycle();
	} else {
		this.parent.buildLifeCycle();
	}

	if ( this.parent.vaccinationSvg ) {
		this.parent.updateVaccinationChart();
	} else {
		this.parent.buildVaccinationChart();
	}
};

BuildWidget.prototype.keyChosen = function(topic, func, parent) {
	this.parent.buildKey();
	this.parent.updateMap();
};
(function() {
	var init = function($) {

		// var casesURL = "data/cases-by-who-region.csv";
		// var vaccinationURL = "data/vaccination-by-who-region.csv";
		// var countriesURL = "data/countries.json";
		// var d3URL = "http://d3js.org/d3.v3.min.js";
		// var topojsonURL = "data/topojson.v1.min.js";

		var casesURL = "http://www.nature.com/widget_assets_polopoly/v518n7538/cases-by-who-region.csv";
		var vaccinationURL = "http://www.nature.com/widget_assets_polopoly/v518n7538/vaccination-by-who-region.csv";
		var countriesURL = "http://www.nature.com/widget_assets_polopoly/v518n7538/countries.json";
		var d3URL = "http://www.nature.com/widget_assets_polopoly/v518n7538/d3.v3.min.js";
		var topojsonURL = "http://www.nature.com/widget_assets_polopoly/v518n7538/topojson.v1.min.js";

		// $.when( $.getScript("http://www.nature.com/polopoly_static/js/d3.v3.min.js"),
		$.when( $.getScript(d3URL),
				$.getScript(topojsonURL)
		).then( function () {

			/*	Load the data in parallel */
			/*	https://groups.google.com/forum/#!msg/d3-js/3Y9VHkOOdCM/YnmOPopWUxQJ */
			var caseData;
			var vaccinationData;
			var worldData;
			var remaining = 3;

			d3.csv(casesURL, function (error, d) {
				if (error) {
					$(".widget-status-message").css("display","none");
					$(".widget-error-message").css("display","block");
				} else {
					caseData = d;
					if (!--remaining) buildGraphic();
				}
			});

			d3.csv(vaccinationURL, function (error, d) {
				if (error) {
					$(".widget-status-message").css("display","none");
					$(".widget-error-message").css("display","block");
				} else {
					vaccinationData = d;
					if (!--remaining) buildGraphic();
				}
			});

			d3.json(countriesURL, function(error, world) {

				if (error) {
					$(".widget-status-message").css("display","none");
					$(".widget-error-message").css("display","block");
				} else {
					worldData = world;
					if (!--remaining) buildGraphic();
				}

			});

			function buildGraphic () {
				$(".widget-status-message").css("display","none");
				$(".outerwrapper").css("display","block");

				/* Convert the text numbers into real numbers */
				/* If the number is "" make it "noData" */
				caseData.forEach(function (element) {
					for (var i = 1980; i < 2014; i++) {
						element[i] = parseInt(element[i], 10) || "noData";
					}
				});

				vaccinationData.forEach(function (element) {
					for (var i = 1980; i < 2014; i++) {
						element[i] = parseInt(element[i], 10) || "noData";
					}
				});

				/*  Nest the data by country code */
				var nestedCaseData = d3.nest()
									.key( function (d) {
										return d.ISO_code;
									})
									.entries(caseData);

				var nestedVaccinationData = d3.nest()
									.key( function (d) {
										return d.ISO_code;
									})
									.entries(vaccinationData);

				var features = topojson.feature(worldData, worldData.objects.units).features;

				for (var i = 0; i < features.length; i++) {

					for (var k = 0; k < nestedCaseData.length; k++) {

						if ( nestedCaseData[k].key === features[i].id ) {
							features[i].caseData = nestedCaseData[k].values;
						}
					}

					for (var j = 0; j < nestedVaccinationData.length; j++) {

						if ( nestedVaccinationData[j].key === features[i].id ) {
							features[i].vaccineData = nestedVaccinationData[j].values;
						}
					}
				}

				var params = buildParams();

				var measlesMap = new BuildWidget(params, features, worldData);
				extendObject(measlesMap.pubsub);
				/*	Create subscriptions */
				measlesMap.pubsub.subscribe( "newYearChosen", measlesMap.yearChosen, measlesMap );
				measlesMap.pubsub.subscribe( "newCountryChosen", measlesMap.countryChosen, measlesMap );
				measlesMap.pubsub.subscribe( "newDataReady", measlesMap.dataReady, measlesMap );
				measlesMap.pubsub.subscribe( "newKeyChosen", measlesMap.keyChosen, measlesMap );

				/*	Call functions to bulid the map, brush, checkbox, data, linegraph and tooltip */
				measlesMap.buildMap();
				measlesMap.buildBrush();
				measlesMap.buildKey();
				measlesMap.buildCheckbox();
				measlesMap.buildData(features[measlesMap.params.selectedFeature]);
				measlesMap.buildTooltip();

				d3.select("#toggle-cases").on("click", function() {
					measlesMap.params.showCases = true;
					measlesMap.pubsub.publish("newKeyChosen");
				});

				d3.select("#toggle-vaccination").on("click", function() {
					measlesMap.params.showCases = false;
					measlesMap.pubsub.publish("newKeyChosen");
				});
			}
		});

	/* End of active code */
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined') {
			/*	jQuery ready test for svg */
			if ( document.implementation.hasFeature('http://www.w3.org/TR/SVG11/feature#Image','1.1') ) {
				init(jQuery);
				return;
			} else {
				return;	
			}
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();
</script>
<!--<![endif]-->
<!-- ========= PASTED POLOPOLY FOOTER BELOW ========= -->

</div>							
						</div>
					</section>
				</div>
			</article>
		</div>
	</div>
</div>
</div>
</body>
</html>